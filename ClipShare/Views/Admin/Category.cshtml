@{
    ViewBag.Title = "Categories";
    Layout = "_Layout";
}

<div class="p-4">
    <h2>Categories</h2>
    <button type="button" class="btn btn-primary actions" onclick="createNewRecord()">Create</button>
    <table class="table table-striped table-bordered mt-2">
        <thead>
            <tr>
                <th>Id</th>
                <th>Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
    </table>
</div>

<!-- Modal for Create New Category -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">Create New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newCategoryName" class="form-label">Category Name</label>
                    <input type="text" class="form-control" id="newCategoryName" placeholder="Enter category name">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewCategory()">Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var categories = [];

        $(function () {
            getCategories();
        });

        function getCategories() {
            $.ajax({
                url: "/Admin/GetCategories",
                type: "GET",
                success: function (data) {
                    $('#tableBody').empty();
                    categories = data.result;

                    categories.map((value, index) => {
                        const trTag = `<tr id="trId_${index}"><td></td><td></td><td></td></tr>`;
                        $('#tableBody').append(trTag);
                        displayTableRow('display', index, value.id, value.name);
                    });
                }
            });
        }

        function displayTableRow(mode, index, id, name) {
            $('#trId_' + index).empty();
            let innerHtml = "";
            innerHtml += `<td>${id}</td>`;

            if (mode === 'display') {
                $('.actions').prop('disabled', false);
                innerHtml += `<td>`;
                innerHtml += `<input id="inputId_${index}" type="text" class="form-control" value="${name}" disabled/>`;
                innerHtml += `</td>`;
                innerHtml += `<td>`;
                innerHtml += `<button onclick="displayTableRow('edit', ${index}, ${id}, '${name}')" class="btn btn-warning text-white me-2 actions">Edit</button>`;
                innerHtml += `<button onclick="deleteRecord(${id}, '${name}')" class="btn btn-danger text-white me-2 actions">Delete</button>`;
                innerHtml += `</td>`;
            } else {
                $('.actions').prop('disabled', true);
                innerHtml += ``;
                innerHtml += `<td>
                <input id="inputId_${index}" type="text" class="form-control" value="${name}"/>
                <span class="text-danger" id="validationTextId_${index}"></span>
                </td>`;
                innerHtml += `<td>`;
                innerHtml += `<button onclick="save(${index}, ${id})" class="btn btn-success text-white me-2">Save</button>`;
                innerHtml += `<button onclick="displayTableRow('display', ${index}, ${id}, '${name}')" class="btn btn-warning text-white">Cancel</button>`;
                innerHtml += `</td>`;
            }
            $('#trId_' + index).append(innerHtml);
        }

        function createNewRecord() {
            $('.actions').prop('disabled', true);

            const index = categories.length;

            let innerHtml = `<tr id="trId_${index}">`;
            innerHtml += '<td></td>';
            innerHtml += `<td>
                <input type="text" class="form-control" id="inputId_${index}"/>
                <span class="text-danger" id="validationTextId_${index}"></span>
            </td>`;
            innerHtml += `<td id="tdActionId_${index}"></td>`;
            innerHtml += '</tr>';
            $('#tableBody').append(innerHtml);

            const $tdActionId = $('#tdActionId_' + index);
            const $saveButton = $('<button class="btn btn-success text-white me-2">Save</button>');
            const $cancelButton = $('<button class="btn btn-danger text-white me-2">Cancel</button>');

            $tdActionId.append($saveButton, $cancelButton);

            $saveButton.on('click', function () {
                save(index);
            });

            $cancelButton.on('click', function () {
                $('#trId_' + index).remove();
                $('.actions').prop('disabled', false);
            });
        }

        function save(index, id) {
            const name = $(`#inputId_${index}`).val();
            if (name !== "") {
                const model = {
                    id: id,
                    name: name
                };
                $.ajax({
                    url: "/Admin/AddEditCategory",
                    type: "POST",
                    data: model,
                    success: function (data) {
                        displayNotification(data.isSuccess, data.title, data.message, 'toastr');
                        console.log(data);
                        getCategories();
                    }
                });
            } else {
                $(`#validationTextId_${index}`).text('Name is required');
            }
        }

        async function deleteRecord(id, name){
            // debugger;
            const result = await confirmation('Are you sure you want to remove ' + name + '?');
            if(result){
                $.ajax({
                    url: "/Admin/DeleteCategory/" + id, // Fixed: added missing slash
                    type: "DELETE",
                    success: function(data){
                        displayNotification(data.isSuccess, data.title, data.message, 'modal');
                        getCategories();
                    }
                });
            }
        }
    </script>
}